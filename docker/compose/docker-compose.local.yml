# =========================
# Docker Compose 버전 지정
# =========================
#version: '3.9'

# =========================
# 공통 네트워크 정의
# =========================
networks:
  nova-network:
    driver: bridge                              # 기본 브리지 네트워크 사용

# =========================
# 모든 컨테이너 정의 (services)
# =========================
services:
  # =========================
  # PostgreSQL 데이터베이스
  # =========================
  postgres:
    image: postgres:15-alpine              # 가벼운 Alpine 기반 PostgreSQL 15 버전 이미지
    container_name: nova-postgres          # 컨테이너 이름 (도커 내부에서 식별용)
    restart: always                        # 컨테이너가 중단되면 항상 재시작
    environment:
      POSTGRES_DB: ${POSTGRES_DB}          # .env 파일에서 불러온 환경변수 사용
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${POSTGRES_PORT}:5432"            # 호스트:컨테이너 포트 매핑
    volumes:
 #     - ./data/postgres:/var/lib/postgresql/data  # 데이터 영속 저장 (컨테이너 재시작 시 유지)
      - postgres_data:/var/lib/postgres/data
    networks:
      - ${NETWORK_NAME}                    # 공통 네트워크 사용


  # =========================
  # Redis (캐시/세션 저장용)
  # =========================
  redis:
    image: redis:7-alpine                  # 경량 Redis 7 버전
    container_name: nova-redis
    restart: always
    ports:
      - "${REDIS_PORT}:6379"
    networks:
      - ${NETWORK_NAME}


  # =========================
  # Zookeeper (Kafka 의존 서비스)
  # =========================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0  # Confluent에서 제공하는 최신 Zookeeper 이미지
    container_name: nova-zookeeper
    restart: always
    ports:
      - "${ZOOKEEPER_PORT}:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181          # 클라이언트 통신 포트
      ZOOKEEPER_TICK_TIME: 2000            # Zookeeper 기본 tick 간격(ms)
    networks:
      - ${NETWORK_NAME}


  # =========================
  # Kafka (이벤트 브로커)
  # =========================
  kafka:
    image: confluentinc/cp-kafka:7.4.0     # Confluent Kafka 최신 이미지
    container_name: nova-kafka
    restart: always
    ports:
      - "${KAFKA_PORT}:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: nova-zookeeper:2181                # Zookeeper 주소
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:${KAFKA_PORT}  # Kafka 외부 접근용
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1              # 단일 브로커이므로 1로 설정
    depends_on:
      - zookeeper
    networks:
      - ${NETWORK_NAME}


  # =========================
  # Spring Cloud Config Server
  # =========================
#  config-server:
#    build:
#      context: ../..                                # root 디렉토리 기준 빌드
#      dockerfile: docker/Dockerfile.config-server   # Dockerfile 위치 지정
#    container_name: nova-config-server
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
#      GITHUB_TOKEN: ${GITHUB_TOKEN}                 # private repo 접근 시 필요
#    ports:
#      - "${CONFIG_SERVER_PORT}:8888"
#    networks:
#      - ${NETWORK_NAME}
#    depends_on:
#      - postgres
#      - redis


  # =========================
  # Spring Cloud Discovery (Eureka)
  # =========================
#  discovery-server:
#    build:
#      context: ../..
#      dockerfile: docker/Dockerfile.discovery-server
#    container_name: nova-discovery-server
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
#      SPRING_CONFIG_IMPORT: "optional:configserver:http://config-server:${CONFIG_SERVER_PORT}/"
#    ports:
#      - "${DISCOVERY_SERVER_PORT}:8761"
#    networks:
#      - ${NETWORK_NAME}
#    depends_on:
#      - config-server


  # =========================
  # API Gateway (Spring Cloud Gateway)
  # =========================
#  gateway-server:
#    build:
#      context: ../..
#      dockerfile: docker/Dockerfile.gateway-server
#    container_name: nova-gateway-server
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
#      SPRING_CONFIG_IMPORT: "optional:configserver:http://config-server:${CONFIG_SERVER_PORT}/"
#    ports:
#      - "${GATEWAY_SERVER_PORT}:8080"
#    networks:
#      - ${NETWORK_NAME}
#    depends_on:
#      - discovery-server


  # =========================
  # Auth Service (회원 인증 서비스)
  # =========================
#  auth-service:
#    build:
#      context: ../..
#      dockerfile: docker/Dockerfile.auth-service
#    container_name: nova-auth-service
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
#      SPRING_CONFIG_IMPORT: "optional:configserver:http://config-server:${CONFIG_SERVER_PORT}/"
#    ports:
#      - "${AUTH_SERVICE_PORT}:9000"
#    networks:
#      - ${NETWORK_NAME}
#    depends_on:
#      - gateway-server
#      - postgres
#      - redis


  # =========================
  # User Service (회원 정보 서비스)
  # =========================
  # user-service:
  #   build:
  #     context: ../..
  #     dockerfile: docker/Dockerfile.user-service
  #   container_name: nova-user-service
  #   environment:
  #     SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
  #     SPRING_CONFIG_IMPORT: "optional:configserver:http://config-server:${CONFIG_SERVER_PORT}/"
  #   ports:
  #     - "${USER_SERVICE_PORT}:9001"
  #   networks:
  #     - ${NETWORK_NAME}
  #   depends_on:
  #     - gateway-server
  #     - postgres
  #     - redis


# =========================
# 데이터 영속 볼륨 정의
# =========================
volumes:
  postgres_data: